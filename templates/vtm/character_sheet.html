{% extends "base.html" %}

{% block title %}
{% if character %}{{ character.name }} - VTM Character{% else %}New VTM Character{% endif %}
{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="/static/css/vtm-sheet.css">
<link rel="stylesheet" href="/static/css/vtm-interactive.css">
<link rel="stylesheet" href="/static/css/vtm-phase1.css">
{% endblock %}

{% block content %}
<div class="character-sheet vtm-sheet" x-data="characterSheet({{ character.id if character else 'null' }})">
    
    <!-- Header -->
    <div class="sheet-header-new">
        <h1 class="character-title" x-text="getCharacterTitle()"></h1>
        <h2 class="chronicle-subheader" x-text="data.chronicle || 'No Chronicle'"></h2>
        <div class="save-indicator" x-show="saveStatus !== ''">
            <span x-show="saveStatus === 'saving'">⏳ Saving...</span>
            <span x-show="saveStatus === 'saved'" class="saved">✓ Saved</span>
            <span x-show="saveStatus === 'error'" class="error">⚠ Save Failed</span>
        </div>
    </div>
    
    <!-- 3-Column Grid Layout (ABOVE PAGE BREAK) -->
    <div class="sheet-grid-three-column sheet-grid-above">
        
        <!-- COLUMN 1: Chronicle Info + Attributes + Hunger + Blood Potency -->
        <div class="column-one">
            
            <!-- Chronicle Information - 4 Box Grid -->
            <section class="sheet-section chronicle-grid">
                <h2>Chronicle Information</h2>
                
                <div class="four-box-grid">
                    <!-- Top Left: Personal Info -->
                    <div class="grid-box">
                        <div class="form-group-compact">
                            <label>Pronouns</label>
                            <input type="text" x-model="data.pronouns" @input.debounce.2s="autoSave()">
                        </div>
                        <div class="form-group-compact">
                            <label>True Age</label>
                            <input type="text" x-model="data.true_age" @input.debounce.2s="autoSave()">
                        </div>
                        <div class="form-group-compact">
                            <label>Apparent Age</label>
                            <input type="text" x-model="data.apparent_age" @input.debounce.2s="autoSave()">
                        </div>
                        <div class="form-group-compact">
                            <label>Birth Date</label>
                            <input type="text" x-model="data.date_of_birth" @input.debounce.2s="autoSave()">
                        </div>
                        <div class="form-group-compact">
                            <label>Death Date</label>
                            <input type="text" x-model="data.date_of_death" @input.debounce.2s="autoSave()">
                        </div>
                    </div>
                    
                    <!-- Top Right: Ambition & Desire -->
                    <div class="grid-box">
                        <div class="form-group-compact">
                            <label>Ambition</label>
                            <textarea x-model="data.ambition" @input.debounce.2s="autoSave()" rows="3"></textarea>
                        </div>
                        <div class="form-group-compact">
                            <label>Desire</label>
                            <textarea x-model="data.desire" @input.debounce.2s="autoSave()" rows="3"></textarea>
                        </div>
                    </div>
                    
                    <!-- Bottom Left: Background -->
                    <div class="grid-box">
                        <div class="form-group-compact">
                            <label>Ethnicity</label>
                            <input type="text" x-model="data.ethnicity" @input.debounce.2s="autoSave()">
                        </div>
                        <div class="form-group-compact">
                            <label>Languages</label>
                            <input type="text" x-model="data.languages" @input.debounce.2s="autoSave()">
                        </div>
                        <div class="form-group-compact">
                            <label>Origin</label>
                            <input type="text" x-model="data.birthplace" @input.debounce.2s="autoSave()">
                        </div>
                    </div>
                    
                    <!-- Bottom Right: Trackers (compact) -->
                    <div class="grid-box trackers-compact">
                        <div class="tracker-row-compact">
                            <label>Health</label>
                            <div class="box-tracker-small">
                                <template x-for="i in 10" :key="i">
                                    <div class="health-box small"
                                         :class="getHealthState(i)"
                                         @click="cycleHealth(i)">
                                        <span x-show="getHealthState(i) === 'superficial'">/</span>
                                        <span x-show="getHealthState(i) === 'aggravated'">×</span>
                                    </div>
                                </template>
                            </div>
                        </div>
                        
                        <div class="tracker-row-compact">
                            <label>Willpower</label>
                            <div class="box-tracker-small">
                                <template x-for="i in 10" :key="i">
                                    <div class="willpower-box small"
                                         :class="getWillpowerState(i)"
                                         @click="cycleWillpower(i)">
                                        <span x-show="getWillpowerState(i) === 'superficial'">/</span>
                                        <span x-show="getWillpowerState(i) === 'aggravated'">×</span>
                                    </div>
                                </template>
                            </div>
                        </div>
                        
                        <div class="tracker-row-compact">
                            <label>Humanity</label>
                            <div class="box-tracker-small">
                                <template x-for="i in 10" :key="i">
                                    <div class="humanity-box small"
                                         :class="getHumanityState(i)"
                                         @click="clickHumanity(i)">
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Attributes - 3 Columns Side by Side -->
            <section class="sheet-section">
                <h2>Attributes</h2>
                
                <div class="attributes-three-column">
                    <!-- Physical -->
                    <div class="attribute-column">
                        <h3>Physical</h3>
                        <div class="attribute-row">
                            <span class="attribute-name">Strength</span>
                            <div class="dot-tracker">
                                <template x-for="i in 5" :key="i">
                                    <span class="dot" 
                                          :class="i <= (data.strength || 1) ? 'filled' : 'empty'"
                                          @click="clickDot('strength', i, 1, 5)">●</span>
                                </template>
                            </div>
                        </div>
                        <div class="attribute-row">
                            <span class="attribute-name">Dexterity</span>
                            <div class="dot-tracker">
                                <template x-for="i in 5" :key="i">
                                    <span class="dot" 
                                          :class="i <= (data.dexterity || 1) ? 'filled' : 'empty'"
                                          @click="clickDot('dexterity', i, 1, 5)">●</span>
                                </template>
                            </div>
                        </div>
                        <div class="attribute-row">
                            <span class="attribute-name">Stamina</span>
                            <div class="dot-tracker">
                                <template x-for="i in 5" :key="i">
                                    <span class="dot" 
                                          :class="i <= (data.stamina || 1) ? 'filled' : 'empty'"
                                          @click="clickDot('stamina', i, 1, 5)">●</span>
                                </template>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Social -->
                    <div class="attribute-column">
                        <h3>Social</h3>
                        <div class="attribute-row">
                            <span class="attribute-name">Charisma</span>
                            <div class="dot-tracker">
                                <template x-for="i in 5" :key="i">
                                    <span class="dot" 
                                          :class="i <= (data.charisma || 1) ? 'filled' : 'empty'"
                                          @click="clickDot('charisma', i, 1, 5)">●</span>
                                </template>
                            </div>
                        </div>
                        <div class="attribute-row">
                            <span class="attribute-name">Manipulation</span>
                            <div class="dot-tracker">
                                <template x-for="i in 5" :key="i">
                                    <span class="dot" 
                                          :class="i <= (data.manipulation || 1) ? 'filled' : 'empty'"
                                          @click="clickDot('manipulation', i, 1, 5)">●</span>
                                </template>
                            </div>
                        </div>
                        <div class="attribute-row">
                            <span class="attribute-name">Composure</span>
                            <div class="dot-tracker">
                                <template x-for="i in 5" :key="i">
                                    <span class="dot" 
                                          :class="i <= (data.composure || 1) ? 'filled' : 'empty'"
                                          @click="clickDot('composure', i, 1, 5)">●</span>
                                </template>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mental -->
                    <div class="attribute-column">
                        <h3>Mental</h3>
                        <div class="attribute-row">
                            <span class="attribute-name">Intelligence</span>
                            <div class="dot-tracker">
                                <template x-for="i in 5" :key="i">
                                    <span class="dot" 
                                          :class="i <= (data.intelligence || 1) ? 'filled' : 'empty'"
                                          @click="clickDot('intelligence', i, 1, 5)">●</span>
                                </template>
                            </div>
                        </div>
                        <div class="attribute-row">
                            <span class="attribute-name">Wits</span>
                            <div class="dot-tracker">
                                <template x-for="i in 5" :key="i">
                                    <span class="dot" 
                                          :class="i <= (data.wits || 1) ? 'filled' : 'empty'"
                                          @click="clickDot('wits', i, 1, 5)">●</span>
                                </template>
                            </div>
                        </div>
                        <div class="attribute-row">
                            <span class="attribute-name">Resolve</span>
                            <div class="dot-tracker">
                                <template x-for="i in 5" :key="i">
                                    <span class="dot" 
                                          :class="i <= (data.resolve || 1) ? 'filled' : 'empty'"
                                          @click="clickDot('resolve', i, 1, 5)">●</span>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Hunger -->
            <section class="sheet-section hunger-section">
                <h2>Hunger</h2>
                <div class="dot-tracker hunger-tracker-large">
                    <template x-for="i in 5" :key="i">
                        <span class="dot hunger-dot" 
                              :class="[i <= (data.hunger || 1) ? 'filled' : 'empty', i >= 4 && i <= (data.hunger || 1) ? 'danger' : '']"
                              @click="clickDot('hunger', i, 0, 5)">●</span>
                    </template>
                </div>
            </section>
            
            <!-- Blood Potency -->
            <section class="sheet-section blood-potency-new">
                <h2>Blood Potency</h2>
                
                <!-- BP Tracker as header -->
                <div class="bp-tracker-header">
                    <div class="dot-tracker bp-tracker">
                        <template x-for="i in 10" :key="i">
                            <span class="dot" 
                                  :class="i <= (data.blood_potency || 0) ? 'filled' : 'empty'"
                                  @click="clickDot('blood_potency', i, 0, 10)">●</span>
                        </template>
                    </div>
                </div>
                
                <!-- Two column readout -->
                <div class="bp-two-column">
                    <div class="bp-column-left">
                        <div class="bp-value-row">
                            <span class="bp-label">Blood Surge:</span>
                            <span class="bp-number" x-text="bloodPotencyValues.surge"></span>
                        </div>
                        <div class="bp-value-row">
                            <span class="bp-label">Mend Amount:</span>
                            <span class="bp-number" x-text="bloodPotencyValues.mend"></span>
                        </div>
                        <div class="bp-value-row">
                            <span class="bp-label">Rouse Re-roll:</span>
                            <span class="bp-number" x-text="bloodPotencyValues.rouseReroll"></span>
                        </div>
                    </div>
                    <div class="bp-column-right">
                        <div class="bp-value-row">
                            <span class="bp-label">Power Bonus:</span>
                            <span class="bp-number" x-text="bloodPotencyValues.powerBonus"></span>
                        </div>
                        <div class="bp-value-row">
                            <span class="bp-label">Bane Severity:</span>
                            <span class="bp-number" x-text="bloodPotencyValues.baneSeverity"></span>
                        </div>
                        <div class="bp-value-row">
                            <span class="bp-label">Feeding Penalty:</span>
                            <span class="bp-text" x-text="bloodPotencyValues.feedingPenalty"></span>
                        </div>
                    </div>
                </div>
            </section>
            
        </div>
        
        <!-- DRAGGABLE DIVIDER 1 -->
        <div class="column-divider" @mousedown="startResizing('above', 0, $event)">
            <div class="divider-handle"></div>
        </div>
        
        <!-- COLUMN 2: Character Portraits -->
        <div class="column-two">
            
            <!-- 6-Box Portrait Grid -->
            <section class="sheet-section portrait-six-box">
                <h2>Character Portraits</h2>
                
                <div class="portrait-grid-fixed">
                    <!-- Left: Body (tall) -->
                    <div class="portrait-box portrait-body" 
                         @dblclick="$refs.bodyInput.click()"
                         :style="data.portrait_body ? `background-image: url(${data.portrait_body})` : ''">
                        <template x-if="!data.portrait_body">
                            <div class="portrait-placeholder">Full Body</div>
                        </template>
                    </div>
                    <input type="file" x-ref="bodyInput" @change="uploadPortrait($event, 'body')" accept="image/*" style="display: none;">
                    
                    <!-- Right: 4 hobbies stacked vertically -->
                    <div class="hobby-stack">
                        <template x-for="i in 4" :key="i">
                            <div>
                                <div class="portrait-box portrait-hobby" 
                                     @dblclick="$refs[`hobby${i}Input`].click()"
                                     :style="data[`portrait_hobby_${i}`] ? `background-image: url(${data['portrait_hobby_' + i]})` : ''">
                                    <template x-if="!data[`portrait_hobby_${i}`]">
                                        <div class="portrait-placeholder-small">+</div>
                                    </template>
                                </div>
                                <input type="file" :x-ref="`hobby${i}Input`" @change="uploadPortrait($event, `hobby_${i}`)" accept="image/*" style="display: none;">
                            </div>
                        </template>
                    </div>
                    
                    <!-- Bottom: Face (square, below body) -->
                    <div class="portrait-box portrait-face" 
                         @dblclick="$refs.faceInput.click()"
                         :style="data.portrait_face ? `background-image: url(${data.portrait_face})` : ''">
                        <!-- Alias Overlay -->
                        <div class="alias-overlay">
                            <input type="text" 
                                   x-model="data.alias" 
                                   @input.debounce.2s="autoSave()"
                                   class="alias-input"
                                   placeholder="Alias">
                        </div>
                        <template x-if="!data.portrait_face">
                            <div class="portrait-placeholder">Face</div>
                        </template>
                    </div>
                    <input type="file" x-ref="faceInput" @change="uploadPortrait($event, 'face')" accept="image/*" style="display: none;">
                </div>
            </section>
            
        </div>
        
        <!-- DRAGGABLE DIVIDER 2 -->
        <div class="column-divider" @mousedown="startResizing('above', 1, $event)">
            <div class="divider-handle"></div>
        </div>
        
        <!-- COLUMN 3: Identity & Skills Split -->
        <div class="column-three">
            
            <div class="identity-skills-split">
                
                <!-- Identity (Left Sub-Column) -->
                <div class="identity-column">
                    <section class="sheet-section identity-box">
                        <h2>Identity</h2>
                        
                        <div class="form-group">
                            <label>Clan</label>
                            <select x-model="data.clan" @change="autoSave()">
                                <option value="">Select Clan</option>
                                <option value="brujah">Brujah</option>
                                <option value="gangrel">Gangrel</option>
                                <option value="malkavian">Malkavian</option>
                                <option value="nosferatu">Nosferatu</option>
                                <option value="toreador">Toreador</option>
                                <option value="tremere">Tremere</option>
                                <option value="ventrue">Ventrue</option>
                                <option value="caitiff">Caitiff</option>
                                <option value="thin-blood">Thin-Blood</option>
                                <option value="banu-haqim">Banu Haqim</option>
                                <option value="hecata">Hecata</option>
                                <option value="lasombra">Lasombra</option>
                                <option value="ministry">Ministry</option>
                                <option value="ravnos">Ravnos</option>
                                <option value="salubri">Salubri</option>
                                <option value="tzimisce">Tzimisce</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Sire</label>
                            <input type="text" x-model="data.sire" @input.debounce.2s="autoSave()">
                        </div>
                        
                        <div class="form-group">
                            <label>Generation</label>
                            <select x-model.number="data.generation" @change="autoSave()">
                                <template x-for="gen in 16" :key="gen">
                                    <option :value="gen" x-text="gen"></option>
                                </template>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Predator Type</label>
                            <input type="text" x-model="data.predator" @input.debounce.2s="autoSave()">
                        </div>
                        
                        <!-- Clan Disciplines (faux break) -->
                        <div class="clan-disciplines-inline" x-show="data.clan">
                            <div class="discipline-icons-small" x-html="getClanDisciplineIcons()"></div>
                        </div>
                        
                        <div class="form-group">
                            <label>Bane</label>
                            <select x-model="data.bane_type" @change="autoSave()">
                                <option value="">Select Bane</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Compulsion</label>
                            <select x-model="data.compulsion" @change="autoSave()">
                                <option value="">Select Compulsion</option>
                                <option value="Dominance">Dominance</option>
                                <option value="Hunger">Hunger</option>
                                <option value="Harm">Harm</option>
                                <option value="Paranoia">Paranoia</option>
                                <option value="Perfectionism">Perfectionism</option>
                            </select>
                        </div>
                    </section>
                </div>
                
                <!-- Skills (Right Sub-Column) -->
                <div class="skills-column">
                    <section class="sheet-section skills-clean-list">
                        <h2>Skills</h2>
                        
                        <!-- Physical Skills -->
                        <template x-for="skill in ['athletics', 'brawl', 'craft', 'drive', 'firearms', 'larceny', 'melee', 'stealth', 'survival']" :key="skill">
                            <div class="skill-row-clean">
                                <div>
                                    <span class="skill-name" x-text="capitalize(skill)"></span>
                                    <div class="skill-right">
                                        <div class="dot-tracker">
                                            <template x-for="i in 5" :key="i">
                                                <span class="dot" 
                                                      :class="i <= (data[skill] || 0) ? 'filled' : 'empty'"
                                                      @click="clickDot(skill, i, 0, 5)">●</span>
                                            </template>
                                        </div>
                                        <button type="button" 
                                                class="btn-add-specialty" 
                                                x-show="data[skill] > 0"
                                                @click="addSpecialty(skill)">+</button>
                                    </div>
                                </div>
                                <div class="specialties-list" x-show="getSpecialties(skill).length > 0">
                                    <template x-for="spec in getSpecialties(skill)" :key="spec">
                                        <span class="specialty-tag">
                                            <span x-text="spec"></span>
                                            <button type="button" @click="removeSpecialty(skill, spec)">×</button>
                                        </span>
                                    </template>
                                </div>
                            </div>
                        </template>
                        
                        <div class="skill-spacer"></div>
                        
                        <!-- Social Skills -->
                        <template x-for="skill in ['animal_ken', 'etiquette', 'insight', 'intimidation', 'leadership', 'performance', 'persuasion', 'streetwise', 'subterfuge']" :key="skill">
                            <div class="skill-row-clean">
                                <div>
                                    <span class="skill-name" x-text="capitalize(skill)"></span>
                                    <div class="skill-right">
                                        <div class="dot-tracker">
                                            <template x-for="i in 5" :key="i">
                                                <span class="dot" 
                                                      :class="i <= (data[skill] || 0) ? 'filled' : 'empty'"
                                                      @click="clickDot(skill, i, 0, 5)">●</span>
                                            </template>
                                        </div>
                                        <button type="button" 
                                                class="btn-add-specialty" 
                                                x-show="data[skill] > 0"
                                                @click="addSpecialty(skill)">+</button>
                                    </div>
                                </div>
                                <div class="specialties-list" x-show="getSpecialties(skill).length > 0">
                                    <template x-for="spec in getSpecialties(skill)" :key="spec">
                                        <span class="specialty-tag">
                                            <span x-text="spec"></span>
                                            <button type="button" @click="removeSpecialty(skill, spec)">×</button>
                                        </span>
                                    </template>
                                </div>
                            </div>
                        </template>
                        
                        <div class="skill-spacer"></div>
                        
                        <!-- Mental Skills -->
                        <template x-for="skill in ['academics', 'awareness', 'finance', 'investigation', 'medicine', 'occult', 'politics', 'science', 'technology']" :key="skill">
                            <div class="skill-row-clean">
                                <div>
                                    <span class="skill-name" x-text="capitalize(skill)"></span>
                                    <div class="skill-right">
                                        <div class="dot-tracker">
                                            <template x-for="i in 5" :key="i">
                                                <span class="dot" 
                                                      :class="i <= (data[skill] || 0) ? 'filled' : 'empty'"
                                                      @click="clickDot(skill, i, 0, 5)">●</span>
                                            </template>
                                        </div>
                                        <button type="button" 
                                                class="btn-add-specialty" 
                                                x-show="data[skill] > 0"
                                                @click="addSpecialty(skill)">+</button>
                                    </div>
                                </div>
                                <div class="specialties-list" x-show="getSpecialties(skill).length > 0">
                                    <template x-for="spec in getSpecialties(skill)" :key="spec">
                                        <span class="specialty-tag">
                                            <span x-text="spec"></span>
                                            <button type="button" @click="removeSpecialty(skill, spec)">×</button>
                                        </span>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </section>
                </div>
                
                <!-- Clan Symbol Overlay -->
                <div class="clan-symbol-overlay" x-show="data.clan">
                    <img :src="`/static/images/clans/${data.clan}.png`" 
                         :alt="data.clan + ' symbol'" 
                         class="clan-symbol-image">
                </div>
            </div>
            
        </div>
        
    </div>
    
    <!-- VISUAL PAGE BREAK -->
    <div class="page-break-divider"></div>
    
    <!-- 3-Column Grid Layout (BELOW PAGE BREAK) -->
    <div class="sheet-grid-three-column sheet-grid-below">
        
        <!-- COLUMN 1: Touchstones + Backgrounds -->
        <div class="column-one">
            
            <!-- Touchstones -->
            <section class="sheet-section">
                <h2>Touchstones</h2>
                
                <template x-for="(touchstone, index) in touchstones" :key="index">
                    <div class="touchstone-entry">
                        <div class="touchstone-header">
                            <strong>Touchstone <span x-text="index + 1"></span></strong>
                            <button type="button" @click="removeTouchstone(index)" class="btn-remove-small">×</button>
                        </div>
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" x-model="touchstone.name" @input.debounce.2s="autoSave()">
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea x-model="touchstone.description" @input.debounce.2s="autoSave()" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Conviction</label>
                            <textarea x-model="touchstone.conviction" @input.debounce.2s="autoSave()" rows="1"></textarea>
                        </div>
                    </div>
                </template>
                
                <button type="button" 
                        @click="addTouchstone()" 
                        x-show="touchstones.length < 3"
                        class="btn-add">+ Add Touchstone</button>
            </section>
            
            <!-- Backgrounds, Merits & Flaws -->
            <section class="sheet-section">
                <h2>Backgrounds, Merits & Flaws</h2>
                
                <template x-for="i in 6" :key="i">
                    <div class="background-entry">
                        <div class="form-group">
                            <input type="text" 
                                   :x-model="`data.background_type_${i}`"
                                   @input.debounce.2s="autoSave()"
                                   :placeholder="`Type`">
                        </div>
                        <div class="form-group">
                            <textarea :x-model="`data.background_description_${i}`"
                                      @input.debounce.2s="autoSave()"
                                      rows="2"
                                      placeholder="Description"></textarea>
                        </div>
                    </div>
                </template>
            </section>
            
        </div>
        
        <!-- DRAGGABLE DIVIDER 1 -->
        <div class="column-divider" @mousedown="startResizing('below', 0, $event)">
            <div class="divider-handle"></div>
        </div>
        
        <!-- COLUMN 2: History in Life + After Death + Notes -->
        <div class="column-two">
            
            <!-- History in Life -->
            <section class="sheet-section">
                <h2>History in Life</h2>
                <textarea x-model="data.history_in_life" 
                          @input.debounce.2s="autoSave()"
                          rows="10"
                          placeholder="Character's mortal history..."></textarea>
            </section>
            
            <!-- After Death -->
            <section class="sheet-section">
                <h2>After Death</h2>
                <textarea x-model="data.after_death" 
                          @input.debounce.2s="autoSave()"
                          rows="10"
                          placeholder="Character's unlife as a vampire..."></textarea>
            </section>
            
            <!-- Notes -->
            <section class="sheet-section">
                <h2>Notes</h2>
                <textarea x-model="data.notes" 
                          @input.debounce.2s="autoSave()"
                          rows="6"
                          placeholder="Additional notes..."></textarea>
            </section>
            
        </div>
        
        <!-- DRAGGABLE DIVIDER 2 -->
        <div class="column-divider" @mousedown="startResizing('below', 1, $event)">
            <div class="divider-handle"></div>
        </div>
        
        <!-- COLUMN 3: Disciplines + Chronicle Tenets + XP -->
        <div class="column-three">
            
            <!-- Disciplines -->
            <section class="sheet-section disciplines-section">
                <h2>Disciplines</h2>
                
                <template x-for="i in 5" :key="i">
                    <div class="discipline-entry">
                        <div class="discipline-header">
                            <select x-model="data['discipline_' + i + '_name']" 
                                    @change="autoSave()"
                                    class="discipline-select">
                                <option value="">Select Discipline</option>
                                <option value="animalism">Animalism</option>
                                <option value="auspex">Auspex</option>
                                <option value="blood-sorcery">Blood Sorcery</option>
                                <option value="celerity">Celerity</option>
                                <option value="dominate">Dominate</option>
                                <option value="fortitude">Fortitude</option>
                                <option value="obfuscate">Obfuscate</option>
                                <option value="oblivion">Oblivion</option>
                                <option value="potence">Potence</option>
                                <option value="presence">Presence</option>
                                <option value="protean">Protean</option>
                                <option value="thin-blood-alchemy">Thin-Blood Alchemy</option>
                            </select>
                            
                            <div class="dot-tracker discipline-dots">
                                <template x-for="d in 5" :key="d">
                                    <span class="dot" 
                                          :class="d <= (data['discipline_' + i + '_level'] || 0) ? 'filled' : 'empty'"
                                          @click="clickDot('discipline_' + i + '_level', d, 0, 5)">●</span>
                                </template>
                            </div>
                        </div>
                        
                        <div class="discipline-powers" x-show="data['discipline_' + i + '_name']">
                            <label>Powers</label>
                            <textarea x-model="data['discipline_' + i + '_powers']" 
                                      @input.debounce.2s="autoSave()"
                                      rows="3"
                                      placeholder="List discipline powers"></textarea>
                        </div>
                        
                        <div class="discipline-description" x-show="data['discipline_' + i + '_name']">
                            <label>Notes</label>
                            <textarea x-model="data['discipline_' + i + '_description']" 
                                      @input.debounce.2s="autoSave()"
                                      rows="2"
                                      placeholder="Custom notes"></textarea>
                        </div>
                    </div>
                </template>
            </section>
            
            <!-- Chronicle Tenets -->
            <section class="sheet-section chronicle-tenets-numbered">
                <h2>Chronicle Tenets</h2>
                
                <template x-for="i in 5" :key="i">
                    <div class="tenet-row">
                        <span class="tenet-numeral" x-text="['I', 'II', 'III', 'IV', 'V'][i-1]"></span>
                        <input type="text" 
                               :x-model="`data.chronicle_tenet_${i}`"
                               @input.debounce.2s="autoSave()"
                               :placeholder="`Tenet ${i}`">
                    </div>
                </template>
            </section>
            
            <!-- Experience Tracker -->
            <section class="sheet-section xp-section">
                <h2>Experience</h2>
                <div class="xp-display">
                    <span class="xp-value" x-text="data.exp_available || 0"></span>
                    <span class="xp-separator">/</span>
                    <span class="xp-total" x-text="data.exp_total || 0"></span>
                </div>
                <div class="xp-buttons">
                    <button type="button" class="btn-small" @click="addXP()">+ Add XP</button>
                    <button type="button" class="btn-small" @click="spendXP()">Spend XP</button>
                </div>
                
                <div class="xp-log" x-show="xpLog.length > 0">
                    <h3>XP Log</h3>
                    <div class="xp-log-entries">
                        <template x-for="(entry, idx) in xpLog.slice().reverse()" :key="idx">
                            <div class="xp-log-entry" :class="entry.type">
                                <span class="xp-date" x-text="entry.date"></span>
                                <span class="xp-amount" x-text="(entry.type === 'add' ? '+' : '-') + entry.amount"></span>
                                <span class="xp-reason" x-text="entry.reason"></span>
                            </div>
                        </template>
                    </div>
                </div>
            </section>
            
        </div>
        
    </div>
    
    <div class="back-link">
        <a href="/vtm">← Back to Character List</a>
    </div>
    
</div>
{% endblock %}

{% block extra_scripts %}
<script src="/static/js/character-sheet.js"></script>
{% endblock %}
