{% extends "base.html" %}

{% block title %}
{% if character %}{{ character.name }} - VTM Character{% else %}New VTM Character{% endif %}
{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="/static/css/vtm-sheet.css">
<link rel="stylesheet" href="/static/css/vtm-interactive.css">
{% endblock %}

{% block content %}
<div class="character-sheet vtm-sheet" x-data="characterSheet({{ character.id if character else 'null' }})">
    
    <!-- Header -->
    <div class="sheet-header">
        <h1 x-text="characterName || 'New Character'"></h1>
        <div class="save-indicator" x-show="saveStatus !== ''">
            <span x-show="saveStatus === 'saving'">⏳ Saving...</span>
            <span x-show="saveStatus === 'saved'" class="saved">✓ Saved</span>
            <span x-show="saveStatus === 'error'" class="error">⚠ Save Failed</span>
        </div>
    </div>
    
    <!-- 3-Column Grid Layout -->
    <div class="sheet-grid">
        
        <!-- LEFT COLUMN -->
        <div class="column-left">
            
            <!-- Chronicle Information -->
            <section class="sheet-section">
                <h2>Chronicle Information</h2>
                
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" 
                           x-model="data.name" 
                           @input.debounce.2s="autoSave()"
                           placeholder="Character Name">
                </div>
                
                <div class="form-group">
                    <label>Chronicle</label>
                    <input type="text" 
                           x-model="data.chronicle" 
                           @input.debounce.2s="autoSave()"
                           placeholder="Chronicle Name">
                </div>
                
                <div class="form-group">
                    <label>Concept</label>
                    <input type="text" 
                           x-model="data.concept" 
                           @input.debounce.2s="autoSave()"
                           placeholder="Concept">
                </div>
                
                <div class="form-group">
                    <label>Predator Type</label>
                    <input type="text" 
                           x-model="data.predator" 
                           @input.debounce.2s="autoSave()"
                           placeholder="Predator Type">
                </div>
                
                <div class="form-group">
                    <label>Ambition</label>
                    <textarea x-model="data.ambition" 
                              @input.debounce.2s="autoSave()"
                              rows="2"
                              placeholder="Long-term goal"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Desire</label>
                    <textarea x-model="data.desire" 
                              @input.debounce.2s="autoSave()"
                              rows="2"
                              placeholder="Short-term want"></textarea>
                </div>
            </section>
            
            <!-- Appearance & Identity -->
            <section class="sheet-section">
                <h2>Appearance & Identity</h2>
                
                <div class="form-row">
                    <div class="form-group half">
                        <label>Apparent Age</label>
                        <input type="text" x-model="data.apparent_age" @input.debounce.2s="autoSave()">
                    </div>
                    <div class="form-group half">
                        <label>True Age</label>
                        <input type="text" x-model="data.true_age" @input.debounce.2s="autoSave()">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group half">
                        <label>Date of Birth</label>
                        <input type="text" x-model="data.date_of_birth" @input.debounce.2s="autoSave()">
                    </div>
                    <div class="form-group half">
                        <label>Date of Death</label>
                        <input type="text" x-model="data.date_of_death" @input.debounce.2s="autoSave()">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Appearance</label>
                    <textarea x-model="data.appearance" 
                              @input.debounce.2s="autoSave()"
                              rows="3"
                              placeholder="Physical description"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Distinguishing Features</label>
                    <textarea x-model="data.distinguishing_features" 
                              @input.debounce.2s="autoSave()"
                              rows="2"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group third">
                        <label>Pronouns</label>
                        <input type="text" x-model="data.pronouns" @input.debounce.2s="autoSave()">
                    </div>
                    <div class="form-group third">
                        <label>Ethnicity</label>
                        <input type="text" x-model="data.ethnicity" @input.debounce.2s="autoSave()">
                    </div>
                    <div class="form-group third">
                        <label>Birthplace</label>
                        <input type="text" x-model="data.birthplace" @input.debounce.2s="autoSave()">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Languages</label>
                    <input type="text" x-model="data.languages" @input.debounce.2s="autoSave()" placeholder="Comma-separated">
                </div>
            </section>
            
            <!-- Attributes -->
            <section class="sheet-section">
                <h2>Attributes</h2>
                
                <div class="attributes-grid">
                    <!-- Physical -->
                    <div class="attribute-category">
                        <h3>Physical</h3>
                        <div class="attribute-row">
                            <span class="attribute-name">Strength</span>
                            <div class="dot-tracker">
                                <template x-for="i in 5" :key="i">
                                    <span class="dot" 
                                          :class="i <= (data.strength || 1) ? 'filled' : 'empty'"
                                          @click="clickDot('strength', i, 1, 5)">●</span>
                                </template>
                            </div>
                        </div>
                        
                        <div class="attribute-row">
                            <span class="attribute-name">Dexterity</span>
                            <div class="dot-tracker">
                                <template x-for="i in 5" :key="i">
                                    <span class="dot" 
                                          :class="i <= (data.dexterity || 1) ? 'filled' : 'empty'"
                                          @click="clickDot('dexterity', i, 1, 5)">●</span>
                                </template>
                            </div>
                        </div>
                        
                        <div class="attribute-row">
                            <span class="attribute-name">Stamina</span>
                            <div class="dot-tracker">
                                <template x-for="i in 5" :key="i">
                                    <span class="dot" 
                                          :class="i <= (data.stamina || 1) ? 'filled' : 'empty'"
                                          @click="clickDot('stamina', i, 1, 5)">●</span>
                                </template>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Social -->
                    <div class="attribute-category">
                        <h3>Social</h3>
                        <div class="attribute-row">
                            <span class="attribute-name">Charisma</span>
                            <div class="dot-tracker">
                                <template x-for="i in 5" :key="i">
                                    <span class="dot" 
                                          :class="i <= (data.charisma || 1) ? 'filled' : 'empty'"
                                          @click="clickDot('charisma', i, 1, 5)">●</span>
                                </template>
                            </div>
                        </div>
                        
                        <div class="attribute-row">
                            <span class="attribute-name">Manipulation</span>
                            <div class="dot-tracker">
                                <template x-for="i in 5" :key="i">
                                    <span class="dot" 
                                          :class="i <= (data.manipulation || 1) ? 'filled' : 'empty'"
                                          @click="clickDot('manipulation', i, 1, 5)">●</span>
                                </template>
                            </div>
                        </div>
                        
                        <div class="attribute-row">
                            <span class="attribute-name">Composure</span>
                            <div class="dot-tracker">
                                <template x-for="i in 5" :key="i">
                                    <span class="dot" 
                                          :class="i <= (data.composure || 1) ? 'filled' : 'empty'"
                                          @click="clickDot('composure', i, 1, 5)">●</span>
                                </template>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mental -->
                    <div class="attribute-category">
                        <h3>Mental</h3>
                        <div class="attribute-row">
                            <span class="attribute-name">Intelligence</span>
                            <div class="dot-tracker">
                                <template x-for="i in 5" :key="i">
                                    <span class="dot" 
                                          :class="i <= (data.intelligence || 1) ? 'filled' : 'empty'"
                                          @click="clickDot('intelligence', i, 1, 5)">●</span>
                                </template>
                            </div>
                        </div>
                        
                        <div class="attribute-row">
                            <span class="attribute-name">Wits</span>
                            <div class="dot-tracker">
                                <template x-for="i in 5" :key="i">
                                    <span class="dot" 
                                          :class="i <= (data.wits || 1) ? 'filled' : 'empty'"
                                          @click="clickDot('wits', i, 1, 5)">●</span>
                                </template>
                            </div>
                        </div>
                        
                        <div class="attribute-row">
                            <span class="attribute-name">Resolve</span>
                            <div class="dot-tracker">
                                <template x-for="i in 5" :key="i">
                                    <span class="dot" 
                                          :class="i <= (data.resolve || 1) ? 'filled' : 'empty'"
                                          @click="clickDot('resolve', i, 1, 5)">●</span>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Hunger & Blood Potency -->
            <section class="sheet-section">
                <h2>Hunger & Blood Potency</h2>
                
                <!-- Hunger (0-5) -->
                <div class="tracker-row">
                    <label>Hunger</label>
                    <div class="dot-tracker hunger-tracker">
                        <template x-for="i in 5" :key="i">
                            <span class="dot hunger-dot" 
                                  :class="[i <= (data.hunger || 1) ? 'filled' : 'empty', i >= 4 && i <= (data.hunger || 1) ? 'danger' : '']"
                                  @click="clickDot('hunger', i, 0, 5)">●</span>
                        </template>
                    </div>
                </div>
                
                <!-- Resonance -->
                <div class="form-group">
                    <label>Resonance</label>
                    <input type="text" x-model="data.resonance" @input.debounce.2s="autoSave()" placeholder="Current resonance">
                </div>
                
                <!-- Blood Potency -->
                <div class="blood-potency-section">
                    <div class="tracker-row">
                        <label>Blood Potency</label>
                        <div class="dot-tracker bp-tracker">
                            <template x-for="i in 10" :key="i">
                                <span class="dot" 
                                      :class="i <= (data.blood_potency || 0) ? 'filled' : 'empty'"
                                      @click="clickDot('blood_potency', i, 0, 10)">●</span>
                            </template>
                        </div>
                    </div>
                    
                    <!-- Auto-calculated BP values -->
                    <div class="bp-values">
                        <div class="bp-value-row">
                            <span class="bp-label">Blood Surge:</span>
                            <span class="bp-number" x-text="bloodPotencyValues.surge"></span>
                        </div>
                        <div class="bp-value-row">
                            <span class="bp-label">Mend Amount:</span>
                            <span class="bp-number" x-text="bloodPotencyValues.mend"></span>
                        </div>
                        <div class="bp-value-row">
                            <span class="bp-label">Power Bonus:</span>
                            <span class="bp-number" x-text="bloodPotencyValues.powerBonus"></span>
                        </div>
                        <div class="bp-value-row">
                            <span class="bp-label">Rouse Re-roll:</span>
                            <span class="bp-number" x-text="bloodPotencyValues.rouseReroll"></span>
                        </div>
                        <div class="bp-value-row">
                            <span class="bp-label">Bane Severity:</span>
                            <span class="bp-number" x-text="bloodPotencyValues.baneSeverity"></span>
                        </div>
                        <div class="bp-value-row">
                            <span class="bp-label">Feeding Penalty:</span>
                            <span class="bp-text" x-text="bloodPotencyValues.feedingPenalty"></span>
                        </div>
                    </div>
                </div>
            </section>
            
            <section class="sheet-section">
                <h2>Touchstones</h2>
                <p class="section-note">You may have 1-3 touchstones</p>
                
                <template x-for="(touchstone, index) in touchstones" :key="index">
                    <div class="touchstone-entry">
                        <div class="touchstone-header">
                            <strong>Touchstone <span x-text="index + 1"></span></strong>
                            <button type="button" @click="removeTouchstone(index)" class="btn-remove-small">×</button>
                        </div>
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" x-model="touchstone.name" @input.debounce.2s="autoSave()">
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea x-model="touchstone.description" @input.debounce.2s="autoSave()" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Conviction</label>
                            <textarea x-model="touchstone.conviction" @input.debounce.2s="autoSave()" rows="1"></textarea>
                        </div>
                    </div>
                </template>
                
                <button type="button" 
                        @click="addTouchstone()" 
                        x-show="touchstones.length < 3"
                        class="btn-add">+ Add Touchstone</button>
            </section>
            
            <!-- Chronicle Tenets -->
            <section class="sheet-section">
                <h2>Chronicle Tenets</h2>
                <textarea x-model="data.chronicle_tenets" 
                          @input.debounce.2s="autoSave()"
                          rows="4"
                          placeholder="I. Tenet one&#10;II. Tenet two&#10;III. Tenet three"></textarea>
            </section>
            
            <!-- Backgrounds, Merits & Flaws -->
            <section class="sheet-section">
                <h2>Backgrounds, Merits & Flaws</h2>
                
                <template x-for="i in 6" :key="i">
                    <div class="background-entry">
                        <div class="form-group">
                            <input type="text" 
                                   :x-model="`data.background_type_${i}`"
                                   @input.debounce.2s="autoSave()"
                                   :placeholder="`Type (e.g., Resources, Fame)`">
                        </div>
                        <div class="form-group">
                            <textarea :x-model="`data.background_description_${i}`"
                                      @input.debounce.2s="autoSave()"
                                      rows="2"
                                      placeholder="Description"></textarea>
                        </div>
                    </div>
                </template>
            </section>
            
        </div>
        
        <!-- CENTER COLUMN -->
        <div class="column-center">
            
            <!-- Character Portrait -->
            <section class="sheet-section portrait-section">
                <div class="portrait-container">
                    <template x-if="data.portrait_url">
                        <img :src="data.portrait_url" alt="Character Portrait">
                    </template>
                    <template x-if="!data.portrait_url">
                        <div class="portrait-placeholder">
                            <span>No Portrait</span>
                        </div>
                    </template>
                </div>
                <button type="button" class="btn-secondary" @click="$refs.portraitInput.click()">
                    <span x-text="data.portrait_url ? 'Change Portrait' : 'Upload Portrait'"></span>
                </button>
                <input type="file" 
                       x-ref="portraitInput" 
                       @change="uploadPortrait($event)" 
                       accept="image/*" 
                       style="display: none;">
            </section>
            
            <!-- Trackers -->
            <section class="sheet-section trackers-section">
                <h2>Trackers</h2>
                
                <!-- Health -->
                <div class="tracker-row">
                    <label>Health</label>
                    <div class="box-tracker health-tracker">
                        <template x-for="i in 10" :key="i">
                            <div class="health-box"
                                 :class="getHealthState(i)"
                                 @click="cycleHealth(i)">
                                <span x-show="getHealthState(i) === 'superficial'">/</span>
                                <span x-show="getHealthState(i) === 'aggravated'">×</span>
                            </div>
                        </template>
                    </div>
                </div>
                
                <!-- Willpower -->
                <div class="tracker-row">
                    <label>Willpower</label>
                    <div class="box-tracker willpower-tracker">
                        <template x-for="i in 10" :key="i">
                            <div class="willpower-box"
                                 :class="getWillpowerState(i)"
                                 @click="cycleWillpower(i)">
                                <span x-show="getWillpowerState(i) === 'superficial'">/</span>
                                <span x-show="getWillpowerState(i) === 'aggravated'">×</span>
                            </div>
                        </template>
                    </div>
                </div>
                
                <!-- Humanity -->
                <div class="tracker-row">
                    <label>Humanity</label>
                    <div class="box-tracker humanity-tracker">
                        <template x-for="i in 10" :key="i">
                            <div class="humanity-box"
                                 :class="getHumanityState(i)"
                                 @click="clickHumanity(i)">
                            </div>
                        </template>
                    </div>
                </div>
            </section>
            
            <!-- Clan, Generation, Bane -->
            <section class="sheet-section">
                <h2>Identity</h2>
                
                <div class="form-group">
                    <label>Clan</label>
                    <select x-model="data.clan" @change="autoSave(); updateClanBadge()">
                        <option value="">Select Clan</option>
                        <option value="brujah">Brujah</option>
                        <option value="gangrel">Gangrel</option>
                        <option value="malkavian">Malkavian</option>
                        <option value="nosferatu">Nosferatu</option>
                        <option value="toreador">Toreador</option>
                        <option value="tremere">Tremere</option>
                        <option value="ventrue">Ventrue</option>
                        <option value="caitiff">Caitiff</option>
                        <option value="thin-blood">Thin-Blood</option>
                        <option value="banu-haqim">Banu Haqim</option>
                        <option value="hecata">Hecata</option>
                        <option value="lasombra">Lasombra</option>
                        <option value="ministry">Ministry</option>
                        <option value="ravnos">Ravnos</option>
                        <option value="salubri">Salubri</option>
                        <option value="tzimisce">Tzimisce</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Sire</label>
                    <input type="text" x-model="data.sire" @input.debounce.2s="autoSave()" placeholder="Sire's name">
                </div>
                
                <div class="form-group">
                    <label>Generation</label>
                    <select x-model.number="data.generation" @change="autoSave()">
                        <template x-for="gen in 16" :key="gen">
                            <option :value="gen" x-text="gen"></option>
                        </template>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Bane</label>
                    <select x-model="data.bane_type" @change="autoSave()">
                        <option value="">Select Bane</option>
                        <template x-if="data.clan === 'brujah'">
                            <optgroup label="Brujah Banes">
                                <option value="Violent Temper">Violent Temper</option>
                                <option value="Zealotry">Zealotry</option>
                            </optgroup>
                        </template>
                        <template x-if="data.clan === 'gangrel'">
                            <optgroup label="Gangrel Banes">
                                <option value="Bestial Features">Bestial Features</option>
                                <option value="Feral Impulses">Feral Impulses</option>
                            </optgroup>
                        </template>
                        <template x-if="data.clan === 'malkavian'">
                            <optgroup label="Malkavian Banes">
                                <option value="Fractured Perspective">Fractured Perspective</option>
                                <option value="Delusion">Delusion</option>
                            </optgroup>
                        </template>
                        <template x-if="data.clan === 'nosferatu'">
                            <optgroup label="Nosferatu Banes">
                                <option value="Repulsiveness">Repulsiveness</option>
                                <option value="Unnatural Aura">Unnatural Aura</option>
                            </optgroup>
                        </template>
                        <template x-if="data.clan === 'toreador'">
                            <optgroup label="Toreador Banes">
                                <option value="Aesthetic Fixation">Aesthetic Fixation</option>
                                <option value="Obsessive Fascination">Obsessive Fascination</option>
                            </optgroup>
                        </template>
                        <template x-if="data.clan === 'tremere'">
                            <optgroup label="Tremere Banes">
                                <option value="Deficient Blood">Deficient Blood</option>
                                <option value="Vitae Addiction">Vitae Addiction</option>
                            </optgroup>
                        </template>
                        <template x-if="data.clan === 'ventrue'">
                            <optgroup label="Ventrue Banes">
                                <option value="Rarefied Taste">Rarefied Taste</option>
                                <option value="Rigid Predilections">Rigid Predilections</option>
                            </optgroup>
                        </template>
                        <template x-if="data.clan === 'banu-haqim'">
                            <optgroup label="Banu Haqim Banes">
                                <option value="Blood Addiction">Blood Addiction</option>
                                <option value="Grave Curse">Grave Curse</option>
                            </optgroup>
                        </template>
                        <template x-if="data.clan === 'hecata'">
                            <optgroup label="Hecata Banes">
                                <option value="Painful Kiss">Painful Kiss</option>
                                <option value="Disfiguring Brand">Disfiguring Brand</option>
                            </optgroup>
                        </template>
                        <template x-if="data.clan === 'lasombra'">
                            <optgroup label="Lasombra Banes">
                                <option value="No Reflection">No Reflection</option>
                                <option value="Shadow Cast">Shadow Cast</option>
                            </optgroup>
                        </template>
                        <template x-if="data.clan === 'ministry'">
                            <optgroup label="Ministry Banes">
                                <option value="Light Sensitivity">Light Sensitivity</option>
                                <option value="Scale Pattern">Scale Pattern</option>
                            </optgroup>
                        </template>
                        <template x-if="data.clan === 'ravnos'">
                            <optgroup label="Ravnos Banes">
                                <option value="Doomed by Reputation">Doomed by Reputation</option>
                                <option value="Cursed by Vice">Cursed by Vice</option>
                            </optgroup>
                        </template>
                        <template x-if="data.clan === 'salubri'">
                            <optgroup label="Salubri Banes">
                                <option value="Third Eye">Third Eye</option>
                                <option value="Conspicuous Aura">Conspicuous Aura</option>
                            </optgroup>
                        </template>
                        <template x-if="data.clan === 'tzimisce'">
                            <optgroup label="Tzimisce Banes">
                                <option value="Soil Dependence">Soil Dependence</option>
                                <option value="Repulsive">Repulsive</option>
                            </optgroup>
                        </template>
                        <template x-if="data.clan === 'caitiff'">
                            <optgroup label="Caitiff Banes">
                                <option value="Clanless Stigma">Clanless Stigma</option>
                            </optgroup>
                        </template>
                        <template x-if="data.clan === 'thin-blood'">
                            <optgroup label="Thin-Blood Banes">
                                <option value="Thin Vitae">Thin Vitae</option>
                                <option value="Mortal Frailty">Mortal Frailty</option>
                            </optgroup>
                        </template>
                    </select>
                </div>
                
                <!-- Clan Discipline Icons -->
                <div class="clan-disciplines" x-show="data.clan">
                    <label>Clan Disciplines</label>
                    <div class="discipline-icons" x-html="getClanDisciplineIcons()"></div>
                </div>
                
                <div class="form-group">
                    <label>Compulsion</label>
                    <select x-model="data.compulsion" @change="autoSave()">
                        <option value="">Select Compulsion</option>
                        <option value="Dominance">Dominance</option>
                        <option value="Hunger">Hunger</option>
                        <option value="Harm">Harm</option>
                        <option value="Paranoia">Paranoia</option>
                        <option value="Perfectionism">Perfectionism</option>
                        <option value="Cryptophilia">Cryptophilia</option>
                        <option value="Judgment">Judgment</option>
                        <option value="Cowardice">Cowardice</option>
                        <option value="Rebellion">Rebellion</option>
                        <option value="Temptation">Temptation</option>
                        <option value="Obsession">Obsession</option>
                        <option value="Greed">Greed</option>
                        <option value="Transgression">Transgression</option>
                    </select>
                </div>
            </section>
            
            <!-- History in Life -->
            <section class="sheet-section">
                <h2>History in Life</h2>
                <textarea x-model="data.history_in_life" 
                          @input.debounce.2s="autoSave()"
                          rows="8"
                          placeholder="Character's mortal history..."></textarea>
            </section>
            
            <!-- After Death -->
            <section class="sheet-section">
                <h2>After Death</h2>
                <textarea x-model="data.after_death" 
                          @input.debounce.2s="autoSave()"
                          rows="8"
                          placeholder="Character's unlife as a vampire..."></textarea>
            </section>
            
            <!-- Notes -->
            <section class="sheet-section">
                <h2>Notes</h2>
                <textarea x-model="data.notes" 
                          @input.debounce.2s="autoSave()"
                          rows="6"
                          placeholder="Additional notes..."></textarea>
            </section>
            
        </div>
        
        <!-- RIGHT COLUMN -->
        <div class="column-right">
            
            <!-- Clan Badge -->
            <section class="sheet-section clan-badge-section">
                <div class="clan-badge-container">
                    <template x-if="data.clan">
                        <img :src="`/static/images/clans/${data.clan}.png`" 
                             :alt="data.clan + ' symbol'" 
                             class="clan-badge">
                    </template>
                    <template x-if="!data.clan">
                        <div class="badge-placeholder">Select Clan</div>
                    </template>
                </div>
            </section>
            
            <!-- Skills -->
            <section class="sheet-section skills-section">
                <h2>Skills</h2>
                
                <!-- Physical Skills -->
                <div class="skill-category">
                    <h3>Physical</h3>
                    
                    <template x-for="skill in ['athletics', 'brawl', 'craft', 'drive', 'firearms', 'larceny', 'melee', 'stealth', 'survival']" :key="skill">
                        <div class="skill-row">
                            <div>
                                <span class="skill-name" x-text="capitalize(skill)"></span>
                                <div class="skill-right">
                                    <div class="dot-tracker">
                                        <template x-for="i in 5" :key="i">
                                            <span class="dot" 
                                                  :class="i <= (data[skill] || 0) ? 'filled' : 'empty'"
                                                  @click="clickDot(skill, i, 0, 5)">●</span>
                                        </template>
                                    </div>
                                    <button type="button" 
                                            class="btn-add-specialty" 
                                            x-show="data[skill] > 0"
                                            @click="addSpecialty(skill)">+</button>
                                </div>
                            </div>
                            <div class="specialties-list" x-show="getSpecialties(skill).length > 0">
                                <template x-for="spec in getSpecialties(skill)" :key="spec">
                                    <span class="specialty-tag">
                                        <span x-text="spec"></span>
                                        <button type="button" @click="removeSpecialty(skill, spec)">×</button>
                                    </span>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
                
                <!-- Social Skills -->
                <div class="skill-category">
                    <h3>Social</h3>
                    
                    <template x-for="skill in ['animal_ken', 'etiquette', 'insight', 'intimidation', 'leadership', 'performance', 'persuasion', 'streetwise', 'subterfuge']" :key="skill">
                        <div class="skill-row">
                            <div>
                                <span class="skill-name" x-text="capitalize(skill)"></span>
                                <div class="skill-right">
                                    <div class="dot-tracker">
                                        <template x-for="i in 5" :key="i">
                                            <span class="dot" 
                                                  :class="i <= (data[skill] || 0) ? 'filled' : 'empty'"
                                                  @click="clickDot(skill, i, 0, 5)">●</span>
                                        </template>
                                    </div>
                                    <button type="button" 
                                            class="btn-add-specialty" 
                                            x-show="data[skill] > 0"
                                            @click="addSpecialty(skill)">+</button>
                                </div>
                            </div>
                            <div class="specialties-list" x-show="getSpecialties(skill).length > 0">
                                <template x-for="spec in getSpecialties(skill)" :key="spec">
                                    <span class="specialty-tag">
                                        <span x-text="spec"></span>
                                        <button type="button" @click="removeSpecialty(skill, spec)">×</button>
                                    </span>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
                
                <!-- Mental Skills -->
                <div class="skill-category">
                    <h3>Mental</h3>
                    
                    <template x-for="skill in ['academics', 'awareness', 'finance', 'investigation', 'medicine', 'occult', 'politics', 'science', 'technology']" :key="skill">
                        <div class="skill-row">
                            <div>
                                <span class="skill-name" x-text="capitalize(skill)"></span>
                                <div class="skill-right">
                                    <div class="dot-tracker">
                                        <template x-for="i in 5" :key="i">
                                            <span class="dot" 
                                                  :class="i <= (data[skill] || 0) ? 'filled' : 'empty'"
                                                  @click="clickDot(skill, i, 0, 5)">●</span>
                                        </template>
                                    </div>
                                    <button type="button" 
                                            class="btn-add-specialty" 
                                            x-show="data[skill] > 0"
                                            @click="addSpecialty(skill)">+</button>
                                </div>
                            </div>
                            <div class="specialties-list" x-show="getSpecialties(skill).length > 0">
                                <template x-for="spec in getSpecialties(skill)" :key="spec">
                                    <span class="specialty-tag">
                                        <span x-text="spec"></span>
                                        <button type="button" @click="removeSpecialty(skill, spec)">×</button>
                                    </span>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
            </section>
            
            <!-- Disciplines -->
            <section class="sheet-section disciplines-section">
                <h2>Disciplines</h2>
                
                <template x-for="i in 5" :key="i">
                    <div class="discipline-entry">
                        <div class="discipline-header">
                            <select x-model="data['discipline_' + i + '_name']" 
                                    @change="autoSave()"
                                    class="discipline-select">
                                <option value="">Select Discipline</option>
                                <option value="animalism">Animalism</option>
                                <option value="auspex">Auspex</option>
                                <option value="blood-sorcery">Blood Sorcery</option>
                                <option value="celerity">Celerity</option>
                                <option value="dominate">Dominate</option>
                                <option value="fortitude">Fortitude</option>
                                <option value="obfuscate">Obfuscate</option>
                                <option value="oblivion">Oblivion</option>
                                <option value="potence">Potence</option>
                                <option value="presence">Presence</option>
                                <option value="protean">Protean</option>
                                <option value="thin-blood-alchemy">Thin-Blood Alchemy</option>
                            </select>
                            
                            <div class="dot-tracker discipline-dots">
                                <template x-for="d in 5" :key="d">
                                    <span class="dot" 
                                          :class="d <= (data['discipline_' + i + '_level'] || 0) ? 'filled' : 'empty'"
                                          @click="clickDot('discipline_' + i + '_level', d, 0, 5)">●</span>
                                </template>
                            </div>
                        </div>
                        
                        <div class="discipline-powers" x-show="data['discipline_' + i + '_name']">
                            <label>Powers</label>
                            <textarea x-model="data['discipline_' + i + '_powers']" 
                                      @input.debounce.2s="autoSave()"
                                      rows="3"
                                      placeholder="List discipline powers (one per line)"></textarea>
                        </div>
                        
                        <div class="discipline-description" x-show="data['discipline_' + i + '_name']">
                            <label>Notes</label>
                            <textarea x-model="data['discipline_' + i + '_description']" 
                                      @input.debounce.2s="autoSave()"
                                      rows="2"
                                      placeholder="Custom notes"></textarea>
                        </div>
                    </div>
                </template>
            </section>
            
            <!-- Experience Tracker -->
            <section class="sheet-section xp-section">
                <h2>Experience</h2>
                <div class="xp-display">
                    <span class="xp-value" x-text="data.exp_available || 0"></span>
                    <span class="xp-separator">/</span>
                    <span class="xp-total" x-text="data.exp_total || 0"></span>
                </div>
                <div class="xp-buttons">
                    <button type="button" class="btn-small" @click="addXP()">+ Add XP</button>
                    <button type="button" class="btn-small" @click="spendXP()">Spend XP</button>
                </div>
                
                <!-- XP Log -->
                <div class="xp-log" x-show="xpLog.length > 0">
                    <h3>XP Log</h3>
                    <div class="xp-log-entries">
                        <template x-for="(entry, idx) in xpLog.slice().reverse()" :key="idx">
                            <div class="xp-log-entry" :class="entry.type">
                                <span class="xp-date" x-text="entry.date"></span>
                                <span class="xp-amount" x-text="(entry.type === 'add' ? '+' : '-') + entry.amount"></span>
                                <span class="xp-reason" x-text="entry.reason"></span>
                            </div>
                        </template>
                    </div>
                </div>
            </section>
            
        </div>
        
    </div>
    
    <div class="back-link">
        <a href="/vtm">← Back to Character List</a>
    </div>
    
</div>
{% endblock %}

{% block extra_scripts %}
<script src="/static/js/character-sheet.js"></script>
{% endblock %}
