{% extends "base.html" %}

{% block title %}
{% if character %}{{ character.name }} - VTM Character{% else %}New VTM Character{% endif %}
{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="/static/css/vtm-sheet.css?v={{ static_version }}">
<link rel="stylesheet" href="/static/css/vtm-interactive.css?v={{ static_version }}">
<link rel="stylesheet" href="/static/css/vtm-phase1.css?v={{ static_version }}">
<script>
    // Global static version for cache-busting
    window.STATIC_VERSION = '{{ static_version }}';
</script>
{% if view_mode %}
<style>
    /* View-Only Mode Styles */
    .view-only-mode input,
    .view-only-mode textarea,
    .view-only-mode select,
    .view-only-mode [contenteditable] {
        pointer-events: none !important;
        cursor: default !important;
        background: rgba(100, 100, 100, 0.1) !important;
        border-color: rgba(100, 100, 100, 0.3) !important;
    }

    .view-only-mode [contenteditable] {
        user-select: text !important;
    }

    .view-only-mode .dot,
    .view-only-mode .health-box,
    .view-only-mode .willpower-box,
    .view-only-mode .humanity-box,
    .view-only-mode .box-tracker-small span,
    .view-only-mode .skill-dot,
    .view-only-mode .attribute-dot,
    .view-only-mode button,
    .view-only-mode .btn,
    .view-only-mode .portrait-upload,
    .view-only-mode .image-upload-overlay {
        pointer-events: none !important;
        cursor: default !important;
    }

    /* Hide save indicator and buttons in view mode */
    .view-only-mode .save-indicator,
    .view-only-mode .btn-delete,
    .view-only-mode .btn-save,
    .view-only-mode .upload-btn {
        display: none !important;
    }

    /* Allow text selection for copying */
    .view-only-mode * {
        user-select: text !important;
    }
</style>
{% endif %}
{% endblock %}

{% block content %}
{% if view_mode %}
<!-- Storyteller View Mode Banner -->
<div style="background: linear-gradient(135deg, #d4af37 0%, #8b6914 100%); color: #1a1a2e; padding: 1rem 2rem; text-align: center; font-weight: bold; margin-bottom: 1rem; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">
    üìñ STORYTELLER VIEW - Read-Only Mode | Character owned by: {{ character_owner }}
</div>
{% endif %}

<div class="character-sheet vtm-sheet{% if view_mode %} view-only-mode{% endif %}" x-data="characterSheet({{ character.id if character else 'null' }})">

    <!-- Loading Spinner -->
    <div x-show="isLoading" class="loading-overlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Loading character data...</p>
        </div>
    </div>

    <!-- Error State -->
    <div x-show="loadError && !isLoading" class="error-overlay">
        <div class="error-message">
            <span class="error-icon">‚ö†Ô∏è</span>
            <h2>Error Loading Character</h2>
            <p x-text="loadError"></p>
            <button @click="location.reload()" class="btn-retry">Retry</button>
            <a href="/vtm" class="btn-back">Back to Character List</a>
        </div>
    </div>

    <!-- Main Content (hidden while loading) -->
    <div x-show="!isLoading && !loadError">

    <!-- Header -->
    <div class="sheet-header-new">
        <h1 class="character-title" x-text="getCharacterTitle()"></h1>
        <h2 class="chronicle-subheader"
            contenteditable="true"
            @blur="data.chronicle = $event.target.textContent; autoSave()"
            @keydown.enter.prevent="$event.target.blur()"
            x-text="data.chronicle || 'No Chronicle'"></h2>
        <div class="save-indicator" x-show="saveStatus !== ''">
            <span x-show="saveStatus === 'saving'">‚è≥ Saving...</span>
            <span x-show="saveStatus === 'saved'" class="saved">‚úì Saved</span>
            <span x-show="saveStatus === 'error'" class="error">‚ö† Save Failed</span>
        </div>
        <!-- Clan Symbol in Header -->
        <div class="clan-symbol-header" x-show="data.clan">
            <img :src="`/static/images/clans/${data.clan}.png?v=${window.STATIC_VERSION}`"
                 :alt="data.clan"
                 class="clan-symbol-image-header"
                 onerror="this.style.display='none'">
        </div>
    </div>
    
    <!-- 3-Column Grid Layout (ABOVE PAGE BREAK) -->
    <div class="sheet-grid-three-column sheet-grid-above">
        
        <!-- COLUMN 1: Chronicle Info + Attributes + Hunger + Blood Potency -->
        <div class="column-one">
            
            <!-- Chronicle Information - Single Box -->
            <section class="sheet-section chronicle-grid">
                <h2>Chronicle Information</h2>
                
                <div class="grid-box">
                    <div class="form-group-compact-horizontal">
                        <label>Name:</label>
                        <input type="text" x-model="data.name" @input.debounce.300ms="autoSave()">
                    </div>
                    <div class="form-group-compact-horizontal">
                        <label>Concept:</label>
                        <input type="text" x-model="data.concept" @input.debounce.300ms="autoSave()">
                    </div>
                    <div class="form-group-compact-horizontal">
                        <label>Pronouns:</label>
                        <input type="text" x-model="data.pronouns" @input.debounce.300ms="autoSave()">
                    </div>
                    <div class="form-group-compact-horizontal">
                        <label>True Age:</label>
                        <input type="text" x-model="data.true_age" @input.debounce.300ms="autoSave()">
                    </div>
                    <div class="form-group-compact-horizontal">
                        <label>Apparent Age:</label>
                        <input type="text" x-model="data.apparent_age" @input.debounce.300ms="autoSave()">
                    </div>
                    <div class="form-group-compact-horizontal">
                        <label>Date of Birth:</label>
                        <input type="text" x-model="data.date_of_birth" @input.debounce.300ms="autoSave()">
                    </div>
                    <div class="form-group-compact-horizontal">
                        <label>Date of Death:</label>
                        <input type="text" x-model="data.date_of_death" @input.debounce.300ms="autoSave()">
                    </div>
                    <div class="form-group-compact-horizontal">
                        <label>Ethnicity:</label>
                        <input type="text" x-model="data.ethnicity" @input.debounce.300ms="autoSave()">
                    </div>
                    <div class="form-group-compact-horizontal">
                        <label>Languages:</label>
                        <input type="text" x-model="data.languages" @input.debounce.300ms="autoSave()">
                    </div>
                    <div class="form-group-compact-horizontal">
                        <label>Origin:</label>
                        <input type="text" x-model="data.birthplace" @input.debounce.300ms="autoSave()">
                    </div>
                    <div class="form-group-compact">
                        <label>Ambition</label>
                        <textarea x-model="data.ambition" @input.debounce.300ms="autoSave()" rows="2"></textarea>
                    </div>
                    <div class="form-group-compact">
                        <label>Desire</label>
                        <textarea x-model="data.desire" @input.debounce.300ms="autoSave()" rows="2"></textarea>
                    </div>
                </div>
            </section>
            
            <!-- Health/Willpower/Humanity Trackers (moved from Chronicle grid) -->
            <section class="sheet-section trackers-section">
                <h2>Trackers</h2>
                <div class="trackers-compact">
                    <!-- Hunger (moved from standalone section) -->
                    <div class="tracker-row-compact">
                        <label>Hunger</label>
                        <div class="box-tracker-small hunger-dots-compact">
                            <template x-for="i in 5" :key="i">
                                <span class="dot hunger-dot-compact" 
                                      :class="[i <= (data.hunger || 1) ? 'filled' : 'empty', i >= 4 && i <= (data.hunger || 1) ? 'danger' : '']"
                                      @click="clickDot('hunger', i, 0, 5)">‚óè</span>
                            </template>
                        </div>
                    </div>
                    
                    <div class="tracker-row-compact">
                        <label>Health</label>
                        <div class="box-tracker-small">
                            <template x-for="i in 10" :key="i">
                                <div class="health-box small"
                                     :class="getHealthState(i)"
                                     @click="cycleHealth(i)">
                                    <span x-show="getHealthState(i) === 'superficial'">/</span>
                                    <span x-show="getHealthState(i) === 'aggravated'">√ó</span>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <div class="tracker-row-compact">
                        <label>Willpower</label>
                        <div class="box-tracker-small">
                            <template x-for="i in 10" :key="i">
                                <div class="willpower-box small"
                                     :class="getWillpowerState(i)"
                                     @click="cycleWillpower(i)">
                                    <span x-show="getWillpowerState(i) === 'superficial'">/</span>
                                    <span x-show="getWillpowerState(i) === 'aggravated'">√ó</span>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <div class="tracker-row-compact">
                        <label>Humanity</label>
                        <div class="box-tracker-small">
                            <template x-for="i in 10" :key="i">
                                <div class="humanity-box small"
                                     :class="getHumanityState(i)"
                                     @click="cycleHumanity(i)">
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Attributes - 3 Columns Side by Side -->
            <section class="sheet-section">
                <h2 class="attributes-header">Attributes</h2>
                
                <div class="attributes-three-column">
                    <!-- Physical -->
                    <div class="attribute-column">
                        <div class="attribute-category-label">PHYSICAL</div>
                        <div class="attribute-row">
                            <span class="attribute-name">Strength</span>
                            <div class="dot-tracker">
                                <template x-for="i in 5" :key="i">
                                    <span class="dot" 
                                          :class="i <= (data.strength || 1) ? 'filled' : 'empty'"
                                          @click="clickDot('strength', i, 1, 5)">‚óè</span>
                                </template>
                            </div>
                        </div>
                        <div class="attribute-row">
                            <span class="attribute-name">Dexterity</span>
                            <div class="dot-tracker">
                                <template x-for="i in 5" :key="i">
                                    <span class="dot" 
                                          :class="i <= (data.dexterity || 1) ? 'filled' : 'empty'"
                                          @click="clickDot('dexterity', i, 1, 5)">‚óè</span>
                                </template>
                            </div>
                        </div>
                        <div class="attribute-row">
                            <span class="attribute-name">Stamina</span>
                            <div class="dot-tracker">
                                <template x-for="i in 5" :key="i">
                                    <span class="dot" 
                                          :class="i <= (data.stamina || 1) ? 'filled' : 'empty'"
                                          @click="clickDot('stamina', i, 1, 5)">‚óè</span>
                                </template>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Social -->
                    <div class="attribute-column">
                        <div class="attribute-category-label">SOCIAL</div>
                        <div class="attribute-row">
                            <span class="attribute-name">Charisma</span>
                            <div class="dot-tracker">
                                <template x-for="i in 5" :key="i">
                                    <span class="dot" 
                                          :class="i <= (data.charisma || 1) ? 'filled' : 'empty'"
                                          @click="clickDot('charisma', i, 1, 5)">‚óè</span>
                                </template>
                            </div>
                        </div>
                        <div class="attribute-row">
                            <span class="attribute-name">Manipulation</span>
                            <div class="dot-tracker">
                                <template x-for="i in 5" :key="i">
                                    <span class="dot" 
                                          :class="i <= (data.manipulation || 1) ? 'filled' : 'empty'"
                                          @click="clickDot('manipulation', i, 1, 5)">‚óè</span>
                                </template>
                            </div>
                        </div>
                        <div class="attribute-row">
                            <span class="attribute-name">Composure</span>
                            <div class="dot-tracker">
                                <template x-for="i in 5" :key="i">
                                    <span class="dot" 
                                          :class="i <= (data.composure || 1) ? 'filled' : 'empty'"
                                          @click="clickDot('composure', i, 1, 5)">‚óè</span>
                                </template>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mental -->
                    <div class="attribute-column">
                        <div class="attribute-category-label">MENTAL</div>
                        <div class="attribute-row">
                            <span class="attribute-name">Intelligence</span>
                            <div class="dot-tracker">
                                <template x-for="i in 5" :key="i">
                                    <span class="dot" 
                                          :class="i <= (data.intelligence || 1) ? 'filled' : 'empty'"
                                          @click="clickDot('intelligence', i, 1, 5)">‚óè</span>
                                </template>
                            </div>
                        </div>
                        <div class="attribute-row">
                            <span class="attribute-name">Wits</span>
                            <div class="dot-tracker">
                                <template x-for="i in 5" :key="i">
                                    <span class="dot" 
                                          :class="i <= (data.wits || 1) ? 'filled' : 'empty'"
                                          @click="clickDot('wits', i, 1, 5)">‚óè</span>
                                </template>
                            </div>
                        </div>
                        <div class="attribute-row">
                            <span class="attribute-name">Resolve</span>
                            <div class="dot-tracker">
                                <template x-for="i in 5" :key="i">
                                    <span class="dot" 
                                          :class="i <= (data.resolve || 1) ? 'filled' : 'empty'"
                                          @click="clickDot('resolve', i, 1, 5)">‚óè</span>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Blood Potency -->
            <section class="sheet-section blood-potency-new">
                <h2>Blood Potency</h2>
                
                <!-- BP Tracker as header -->
                <div class="bp-tracker-header">
                    <div class="dot-tracker bp-tracker">
                        <template x-for="i in 10" :key="i">
                            <span class="dot" 
                                  :class="i <= (data.blood_potency || 0) ? 'filled' : 'empty'"
                                  @click="clickDot('blood_potency', i, 0, 10)">‚óè</span>
                        </template>
                    </div>
                </div>
                
                <!-- Two column readout -->
                <div class="bp-two-column">
                    <div class="bp-column-left">
                        <div class="bp-value-row">
                            <span class="bp-label">Blood Surge:</span>
                            <span class="bp-number" x-text="bloodPotencyValues.surge"></span>
                        </div>
                        <div class="bp-value-row">
                            <span class="bp-label">Mend Amount:</span>
                            <span class="bp-number" x-text="bloodPotencyValues.mend"></span>
                        </div>
                        <div class="bp-value-row">
                            <span class="bp-label">Rouse Re-roll:</span>
                            <span class="bp-number" x-text="bloodPotencyValues.rouseReroll"></span>
                        </div>
                    </div>
                    <div class="bp-column-right">
                        <div class="bp-value-row">
                            <span class="bp-label">Power Bonus:</span>
                            <span class="bp-number" x-text="bloodPotencyValues.powerBonus"></span>
                        </div>
                        <div class="bp-value-row">
                            <span class="bp-label">Bane Severity:</span>
                            <span class="bp-number" x-text="bloodPotencyValues.baneSeverity"></span>
                        </div>
                        <div class="bp-value-row">
                            <span class="bp-label">Feeding Penalty:</span>
                            <span class="bp-text" x-text="bloodPotencyValues.feedingPenalty"></span>
                        </div>
                    </div>
                </div>
            </section>
            
        </div>
        
        <!-- DRAGGABLE DIVIDER 1 -->
        <div class="column-divider" @mousedown="startResizing('above', 0, $event)">
            <div class="divider-handle"></div>
        </div>
        
        <!-- COLUMN 2: Character Portraits -->
        <div class="column-two">
            
            <!-- 6-Box Portrait Grid -->
            <section class="sheet-section portrait-six-box">
                <h2>Character Portraits</h2>
                
                <div class="portrait-grid-fixed">
                    <!-- Left: Body (tall) -->
                    <div class="portrait-box portrait-body"
                         @dblclick="$refs.bodyInput.click()"
                         :style="data.portrait_body ? `background-image: url(${data.portrait_body})` : ''">
                        <template x-if="!data.portrait_body">
                            <div class="portrait-placeholder">Full Body<br><span class="size-hint">(400x600)</span></div>
                        </template>
                    </div>
                    <input type="file" x-ref="bodyInput" @change="uploadPortrait($event, 'body')" accept="image/*" style="display: none;">

                    <!-- Right: 4 hobbies stacked vertically -->
                    <div class="hobby-stack">
                        <!-- Hobby 1 -->
                        <div class="portrait-box portrait-hobby"
                             @dblclick="$refs.hobby1Input.click()"
                             :style="data.portrait_hobby_1 ? `background-image: url(${data.portrait_hobby_1})` : ''">
                            <template x-if="!data.portrait_hobby_1">
                                <div class="portrait-placeholder-small">
                                    <div class="hobby-icon">üì∑</div>
                                    <div class="size-hint-small">(200x200)</div>
                                </div>
                            </template>
                        </div>
                        <input type="file" x-ref="hobby1Input" @change="uploadPortrait($event, 'hobby_1')" accept="image/*" style="display: none;">

                        <!-- Hobby 2 -->
                        <div class="portrait-box portrait-hobby"
                             @dblclick="$refs.hobby2Input.click()"
                             :style="data.portrait_hobby_2 ? `background-image: url(${data.portrait_hobby_2})` : ''">
                            <template x-if="!data.portrait_hobby_2">
                                <div class="portrait-placeholder-small">
                                    <div class="hobby-icon">üì∑</div>
                                    <div class="size-hint-small">(200x200)</div>
                                </div>
                            </template>
                        </div>
                        <input type="file" x-ref="hobby2Input" @change="uploadPortrait($event, 'hobby_2')" accept="image/*" style="display: none;">

                        <!-- Hobby 3 -->
                        <div class="portrait-box portrait-hobby"
                             @dblclick="$refs.hobby3Input.click()"
                             :style="data.portrait_hobby_3 ? `background-image: url(${data.portrait_hobby_3})` : ''">
                            <template x-if="!data.portrait_hobby_3">
                                <div class="portrait-placeholder-small">
                                    <div class="hobby-icon">üì∑</div>
                                    <div class="size-hint-small">(200x200)</div>
                                </div>
                            </template>
                        </div>
                        <input type="file" x-ref="hobby3Input" @change="uploadPortrait($event, 'hobby_3')" accept="image/*" style="display: none;">

                        <!-- Hobby 4 -->
                        <div class="portrait-box portrait-hobby"
                             @dblclick="$refs.hobby4Input.click()"
                             :style="data.portrait_hobby_4 ? `background-image: url(${data.portrait_hobby_4})` : ''">
                            <template x-if="!data.portrait_hobby_4">
                                <div class="portrait-placeholder-small">
                                    <div class="hobby-icon">üì∑</div>
                                    <div class="size-hint-small">(200x200)</div>
                                </div>
                            </template>
                        </div>
                        <input type="file" x-ref="hobby4Input" @change="uploadPortrait($event, 'hobby_4')" accept="image/*" style="display: none;">
                    </div>

                    <!-- Alias Overlay - positioned between body and face -->
                    <div class="alias-overlay">
                        <input type="text"
                               x-model="data.alias"
                               @input.debounce.300ms="autoSave()"
                               class="alias-input"
                               placeholder="Alias">
                    </div>

                    <!-- Bottom: Face (square, below body) -->
                    <div class="portrait-box portrait-face"
                         @dblclick="$refs.faceInput.click()"
                         :style="data.portrait_face ? `background-image: url(${data.portrait_face})` : ''">
                        <template x-if="!data.portrait_face">
                            <div class="portrait-placeholder">Face<br><span class="size-hint">(600x600)</span></div>
                        </template>
                    </div>
                    <input type="file" x-ref="faceInput" @change="uploadPortrait($event, 'face')" accept="image/*" style="display: none;">
                </div>
            </section>
            
            <!-- Backgrounds, Merits & Flaws (moved from below break) -->
            <section class="sheet-section">
                <h2>Backgrounds, Merits & Flaws</h2>

                <!-- Empty State -->
                <div x-show="backgrounds.length === 0" class="empty-state">
                    <span class="empty-state-icon">üìã</span>
                    <div class="empty-state-text">No backgrounds yet</div>
                    <div class="empty-state-hint">Add backgrounds, merits, and flaws to define your character</div>
                </div>

                <template x-for="(bg, index) in backgrounds" :key="index">
                    <div class="background-entry">
                        <div class="background-header">
                            <div class="background-type-input">
                                <input type="text" 
                                       x-model="bg.type"
                                       @input.debounce.300ms="autoSave()"
                                       placeholder="Type">
                            </div>
                            <div class="square-tracker">
                                <template x-for="i in 5" :key="i">
                                    <span class="square-dot" 
                                          :class="i <= (bg.dots || 0) ? 'filled' : 'empty'"
                                          @click="bg.dots = i; autoSave()">‚ñ†</span>
                                </template>
                            </div>
                            <button type="button" 
                                    class="btn-remove-bg"
                                    @click="removeBackground(index); autoSave()"
                                    title="Remove">√ó</button>
                        </div>
                        <div class="form-group">
                            <textarea x-model="bg.description"
                                      @input.debounce.300ms="autoSave()"
                                      rows="2"
                                      placeholder="Description"></textarea>
                        </div>
                    </div>
                </template>
                
                <button type="button" 
                        @click="addBackground()" 
                        x-show="backgrounds.length < 10"
                        class="btn-add">+ Add Background/Merit/Flaw</button>
            </section>
            
        </div>
        
        <!-- DRAGGABLE DIVIDER 2 -->
        <div class="column-divider" @mousedown="startResizing('above', 1, $event)">
            <div class="divider-handle"></div>
        </div>
        
        <!-- COLUMN 3: Identity & Skills Split -->
        <div class="column-three">
            
            <div class="identity-skills-stacked">
                
                <!-- Identity (On Top) -->
                <div class="identity-section">
                    <section class="sheet-section identity-box">
                        <h2>Identity</h2>

                        <div class="identity-content">
                            <!-- Clan Symbol Watermark -->
                            <div class="clan-symbol-overlay-identity" x-show="data.clan">
                            <img :src="`/static/images/clans/${data.clan}.png?v=${window.STATIC_VERSION}`"
                                 :alt="data.clan"
                                 class="clan-symbol-image-identity"
                                 onerror="this.style.display='none'">
                        </div>

                        <div class="form-group-compact-horizontal">
                            <label>Clan:</label>
                            <select x-model="data.clan" @change="autoSave()">
                                <option value="">Select Clan</option>
                                <option value="brujah">Brujah</option>
                                <option value="gangrel">Gangrel</option>
                                <option value="malkavian">Malkavian</option>
                                <option value="nosferatu">Nosferatu</option>
                                <option value="toreador">Toreador</option>
                                <option value="tremere">Tremere</option>
                                <option value="ventrue">Ventrue</option>
                                <option value="caitiff">Caitiff</option>
                                <option value="thin-blood">Thin-Blood</option>
                                <option value="banu-haqim">Banu Haqim</option>
                                <option value="hecata">Hecata</option>
                                <option value="lasombra">Lasombra</option>
                                <option value="ministry">Ministry</option>
                                <option value="ravnos">Ravnos</option>
                                <option value="salubri">Salubri</option>
                                <option value="tzimisce">Tzimisce</option>
                            </select>
                        </div>

                        <div class="form-group-compact-horizontal">
                            <label>Generation:</label>
                            <select x-model.number="data.generation" @change="autoSave()">
                                <template x-for="gen in 16" :key="gen">
                                    <option :value="gen" x-text="gen"></option>
                                </template>
                            </select>
                        </div>

                        <div class="form-group-compact-horizontal">
                            <label>Sire:</label>
                            <input type="text" x-model="data.sire" @input.debounce.300ms="autoSave()">
                        </div>

                        <div class="form-group-compact-horizontal">
                            <label>Predator Type:</label>
                            <input type="text" x-model="data.predator" @input.debounce.300ms="autoSave()">
                        </div>

                        <div class="form-group-compact-horizontal">
                            <label>Bane:</label>
                            <select x-model="data.bane_type" @change="autoSave()">
                                <option value="">Select Bane</option>
                                <option value="Bane of the Clan">Bane of the Clan (Generic)</option>
                                <option value="Blood Addiction">Blood Addiction (Banu Haqim)</option>
                                <option value="Bestial Temper">Bestial Temper (Brujah)</option>
                                <option value="Outcast">Outcast (Caitiff)</option>
                                <option value="Feral Impulses">Feral Impulses (Gangrel)</option>
                                <option value="Painful Kiss">Painful Kiss (Hecata)</option>
                                <option value="Distorted Image">Distorted Image (Lasombra)</option>
                                <option value="Fractured Perspective">Fractured Perspective (Malkavian)</option>
                                <option value="Alienation">Alienation (Ministry)</option>
                                <option value="Repulsiveness">Repulsiveness (Nosferatu)</option>
                                <option value="Doomed">Doomed (Ravnos)</option>
                                <option value="Hunted">Hunted (Salubri)</option>
                                <option value="Aesthetic Fixation">Aesthetic Fixation (Toreador)</option>
                                <option value="Deficient Blood">Deficient Blood (Tremere)</option>
                                <option value="Grounded">Grounded (Tzimisce)</option>
                                <option value="Rarefied Tastes">Rarefied Tastes (Ventrue)</option>
                                <option value="Custom">Custom</option>
                            </select>
                        </div>
                        <div x-show="data.bane_type === 'Custom'" class="custom-input-wrapper">
                            <input type="text"
                                   x-model="data.bane_custom"
                                   @input.debounce.300ms="autoSave()"
                                   placeholder="Enter custom bane">
                        </div>

                        <div class="form-group-compact-horizontal">
                            <label>Compulsion:</label>
                            <select x-model="data.compulsion" @change="autoSave()">
                                <option value="">Select Compulsion</option>
                                <option value="Domination">Domination (Brujah)</option>
                                <option value="Rebellion">Rebellion (Brujah)</option>
                                <option value="Tempting Fate">Tempting Fate (Gangrel)</option>
                                <option value="Feral Impulses">Feral Impulses (Gangrel)</option>
                                <option value="Delusion">Delusion (Malkavian)</option>
                                <option value="Cryptophilia">Cryptophilia (Nosferatu)</option>
                                <option value="Obsession">Obsession (Toreador)</option>
                                <option value="Perfectionism">Perfectionism (Tremere)</option>
                                <option value="Arrogance">Arrogance (Ventrue)</option>
                                <option value="Judgment">Judgment (Banu Haqim)</option>
                                <option value="Morbidity">Morbidity (Hecata)</option>
                                <option value="Ruthlessness">Ruthlessness (Lasombra)</option>
                                <option value="Transgression">Transgression (Ministry)</option>
                                <option value="Tempting Fate">Tempting Fate (Ravnos)</option>
                                <option value="Affective Empathy">Affective Empathy (Salubri)</option>
                                <option value="Covetousness">Covetousness (Tzimisce)</option>
                                <option value="Hunger">Hunger (General)</option>
                                <option value="Harm">Harm (General)</option>
                                <option value="Paranoia">Paranoia (General)</option>
                                <option value="Custom">Custom</option>
                            </select>
                        </div>
                        <div x-show="data.compulsion === 'Custom'" class="custom-input-wrapper">
                            <input type="text"
                                   x-model="data.compulsion_custom"
                                   @input.debounce.300ms="autoSave()"
                                   placeholder="Enter custom compulsion">
                        </div>
                        </div><!-- /.identity-content -->
                    </section>
                </div>
                
                <!-- Skills (Below Identity) -->
                <div class="skills-section">
                    <section class="sheet-section skills-clean-list">
                        <h2>Skills</h2>

                        <div class="skills-content">
                        <!-- Physical Skills -->
                        <template x-for="skill in ['athletics', 'brawl', 'craft', 'drive', 'firearms', 'larceny', 'melee', 'stealth', 'survival']" :key="skill">
                            <div class="skill-row-clean">
                                <div>
                                    <span class="skill-name" x-text="capitalize(skill)"></span>
                                    <div class="skill-right">
                                        <div class="dot-tracker">
                                            <template x-for="i in 5" :key="i">
                                                <span class="dot" 
                                                      :class="i <= (data[skill] || 0) ? 'filled' : 'empty'"
                                                      @click="clickDot(skill, i, 0, 5)">‚óè</span>
                                            </template>
                                        </div>
                                        <button type="button" 
                                                class="btn-add-specialty" 
                                                x-show="data[skill] > 0"
                                                @click="addSpecialty(skill)">+</button>
                                    </div>
                                </div>
                                <div class="specialties-list" x-show="getSpecialties(skill).length > 0">
                                    <template x-for="spec in getSpecialties(skill)" :key="spec">
                                        <span class="specialty-tag">
                                            <span x-text="spec"></span>
                                            <button type="button" @click="removeSpecialty(skill, spec)">√ó</button>
                                        </span>
                                    </template>
                                </div>
                            </div>
                        </template>
                        
                        <div class="skill-spacer"></div>
                        
                        <!-- Social Skills -->
                        <template x-for="skill in ['animal_ken', 'etiquette', 'insight', 'intimidation', 'leadership', 'performance', 'persuasion', 'streetwise', 'subterfuge']" :key="skill">
                            <div class="skill-row-clean">
                                <div>
                                    <span class="skill-name" x-text="capitalize(skill)"></span>
                                    <div class="skill-right">
                                        <div class="dot-tracker">
                                            <template x-for="i in 5" :key="i">
                                                <span class="dot" 
                                                      :class="i <= (data[skill] || 0) ? 'filled' : 'empty'"
                                                      @click="clickDot(skill, i, 0, 5)">‚óè</span>
                                            </template>
                                        </div>
                                        <button type="button" 
                                                class="btn-add-specialty" 
                                                x-show="data[skill] > 0"
                                                @click="addSpecialty(skill)">+</button>
                                    </div>
                                </div>
                                <div class="specialties-list" x-show="getSpecialties(skill).length > 0">
                                    <template x-for="spec in getSpecialties(skill)" :key="spec">
                                        <span class="specialty-tag">
                                            <span x-text="spec"></span>
                                            <button type="button" @click="removeSpecialty(skill, spec)">√ó</button>
                                        </span>
                                    </template>
                                </div>
                            </div>
                        </template>
                        
                        <div class="skill-spacer"></div>
                        
                        <!-- Mental Skills -->
                        <template x-for="skill in ['academics', 'awareness', 'finance', 'investigation', 'medicine', 'occult', 'politics', 'science', 'technology']" :key="skill">
                            <div class="skill-row-clean">
                                <div>
                                    <span class="skill-name" x-text="capitalize(skill)"></span>
                                    <div class="skill-right">
                                        <div class="dot-tracker">
                                            <template x-for="i in 5" :key="i">
                                                <span class="dot" 
                                                      :class="i <= (data[skill] || 0) ? 'filled' : 'empty'"
                                                      @click="clickDot(skill, i, 0, 5)">‚óè</span>
                                            </template>
                                        </div>
                                        <button type="button" 
                                                class="btn-add-specialty" 
                                                x-show="data[skill] > 0"
                                                @click="addSpecialty(skill)">+</button>
                                    </div>
                                </div>
                                <div class="specialties-list" x-show="getSpecialties(skill).length > 0">
                                    <template x-for="spec in getSpecialties(skill)" :key="spec">
                                        <span class="specialty-tag">
                                            <span x-text="spec"></span>
                                            <button type="button" @click="removeSpecialty(skill, spec)">√ó</button>
                                        </span>
                                    </template>
                                </div>
                            </div>
                        </template>
                        </div><!-- /.skills-content -->
                    </section>
                </div>

            </div>

        </div>
        
    </div>
    
    <!-- VISUAL PAGE BREAK -->
    <div class="page-break-divider"></div>
    
    <!-- 3-Column Grid Layout (BELOW PAGE BREAK) -->
    <div class="sheet-grid-three-column sheet-grid-below">
        
        <!-- COLUMN 1: Touchstones + Backgrounds -->
        <div class="column-one">
            
            <!-- Touchstones -->
            <section class="sheet-section">
                <h2>Touchstones</h2>

                <!-- Empty State -->
                <div x-show="touchstones.length === 0" class="empty-state">
                    <span class="empty-state-icon">üë§</span>
                    <div class="empty-state-text">No touchstones yet</div>
                    <div class="empty-state-hint">Add touchstones to maintain your Humanity</div>
                </div>

                <template x-for="(touchstone, index) in touchstones" :key="index">
                    <div class="touchstone-entry">
                        <div class="touchstone-header">
                            <strong>Touchstone <span x-text="index + 1"></span></strong>
                            <button type="button" @click="removeTouchstone(index)" class="btn-remove-small">√ó</button>
                        </div>
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" x-model="touchstone.name" @input.debounce.300ms="autoSave()">
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea x-model="touchstone.description" @input.debounce.300ms="autoSave()" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Conviction</label>
                            <textarea x-model="touchstone.conviction" @input.debounce.300ms="autoSave()" rows="1"></textarea>
                        </div>
                    </div>
                </template>
                
                <button type="button" 
                        @click="addTouchstone()" 
                        x-show="touchstones.length < 3"
                        class="btn-add">+ Add Touchstone</button>
            </section>
            
            <!-- Chronicle Tenets (moved from column 3) -->
            <section class="sheet-section chronicle-tenets-numbered">
                <h2>Chronicle Tenets</h2>

                <div class="tenets-content">
                <div class="tenet-row">
                    <span class="tenet-numeral">I</span>
                    <input type="text" 
                           x-model="data.chronicle_tenet_1"
                           @input.debounce.300ms="autoSave()"
                           placeholder="Tenet 1">
                </div>
                <div class="tenet-row">
                    <span class="tenet-numeral">II</span>
                    <input type="text" 
                           x-model="data.chronicle_tenet_2"
                           @input.debounce.300ms="autoSave()"
                           placeholder="Tenet 2">
                </div>
                <div class="tenet-row">
                    <span class="tenet-numeral">III</span>
                    <input type="text" 
                           x-model="data.chronicle_tenet_3"
                           @input.debounce.300ms="autoSave()"
                           placeholder="Tenet 3">
                </div>
                <div class="tenet-row">
                    <span class="tenet-numeral">IV</span>
                    <input type="text" 
                           x-model="data.chronicle_tenet_4"
                           @input.debounce.300ms="autoSave()"
                           placeholder="Tenet 4">
                </div>
                <div class="tenet-row">
                    <span class="tenet-numeral">V</span>
                    <input type="text"
                           x-model="data.chronicle_tenet_5"
                           @input.debounce.300ms="autoSave()"
                           placeholder="Tenet 5">
                </div>
                </div><!-- /.tenets-content -->
            </section>
            
            
        </div>
        
        <!-- DRAGGABLE DIVIDER 1 -->
        <div class="column-divider" @mousedown="startResizing('below', 0, $event)">
            <div class="divider-handle"></div>
        </div>
        
        <!-- COLUMN 2: History in Life + After Death + Notes -->
        <div class="column-two">
            
            <!-- History in Life -->
            <section class="sheet-section">
                <h2>History in Life</h2>
                <textarea x-model="data.history_in_life" 
                          @input.debounce.300ms="autoSave()"
                          rows="10"
                          placeholder="Character's mortal history..."></textarea>
            </section>
            
            <!-- After Death -->
            <section class="sheet-section">
                <h2>After Death</h2>
                <textarea x-model="data.after_death" 
                          @input.debounce.300ms="autoSave()"
                          rows="10"
                          placeholder="Character's unlife as a vampire..."></textarea>
            </section>
            
            <!-- Notes -->
            <section class="sheet-section">
                <h2>Notes</h2>
                <textarea x-model="data.notes" 
                          @input.debounce.300ms="autoSave()"
                          rows="6"
                          placeholder="Additional notes..."></textarea>
            </section>
            
        </div>
        
        <!-- DRAGGABLE DIVIDER 2 -->
        <div class="column-divider" @mousedown="startResizing('below', 1, $event)">
            <div class="divider-handle"></div>
        </div>
        
        <!-- COLUMN 3: Disciplines + Chronicle Tenets + XP -->
        <div class="column-three">
            
            <!-- Disciplines -->
            <section class="sheet-section disciplines-section">
                <h2>Disciplines</h2>
                
                <!-- Clan Discipline Icons (moved from Identity) -->
                <div class="clan-disciplines-header" x-show="data.clan">
                    <div class="discipline-icons-with-labels" x-html="getClanDisciplineIcons()"></div>
                </div>
                
                <template x-for="i in 5" :key="i">
                    <div class="discipline-entry">
                        <div class="discipline-header">
                            <select x-model="data['discipline_' + i + '_name']" 
                                    @change="autoSave()"
                                    class="discipline-select">
                                <option value="">Select Discipline</option>
                                <option value="animalism">Animalism</option>
                                <option value="auspex">Auspex</option>
                                <option value="blood-sorcery">Blood Sorcery</option>
                                <option value="celerity">Celerity</option>
                                <option value="dominate">Dominate</option>
                                <option value="fortitude">Fortitude</option>
                                <option value="obfuscate">Obfuscate</option>
                                <option value="oblivion">Oblivion</option>
                                <option value="potence">Potence</option>
                                <option value="presence">Presence</option>
                                <option value="protean">Protean</option>
                                <option value="thin-blood-alchemy">Thin-Blood Alchemy</option>
                            </select>
                            
                            <div class="dot-tracker discipline-dots">
                                <template x-for="d in 5" :key="d">
                                    <span class="dot" 
                                          :class="d <= (data['discipline_' + i + '_level'] || 0) ? 'filled' : 'empty'"
                                          @click="clickDot('discipline_' + i + '_level', d, 0, 5)">‚óè</span>
                                </template>
                            </div>
                        </div>
                        
                        <div class="discipline-powers" x-show="data['discipline_' + i + '_name']">
                            <label>Powers</label>
                            <textarea x-model="data['discipline_' + i + '_powers']" 
                                      @input.debounce.300ms="autoSave()"
                                      rows="3"
                                      placeholder="List discipline powers"></textarea>
                        </div>
                        
                        <div class="discipline-description" x-show="data['discipline_' + i + '_name']">
                            <label>Notes</label>
                            <textarea x-model="data['discipline_' + i + '_description']" 
                                      @input.debounce.300ms="autoSave()"
                                      rows="2"
                                      placeholder="Custom notes"></textarea>
                        </div>
                    </div>
                </template>
            </section>
            
            <!-- Experience Tracker -->
            <section class="sheet-section xp-section">
                <h2>Experience</h2>
                <div class="xp-display">
                    <span class="xp-value" x-text="data.exp_available || 0"></span>
                    <span class="xp-separator">/</span>
                    <span class="xp-total" x-text="data.exp_total || 0"></span>
                </div>
                <div class="xp-buttons">
                    <button type="button" class="btn-small" @click="addXP()">+ Add XP</button>
                    <button type="button" class="btn-small" @click="spendXP()">Spend XP</button>
                </div>
                
                <div class="xp-log">
                    <h3>XP Log</h3>

                    <!-- Empty State -->
                    <div x-show="xpLog.length === 0" class="empty-state" style="padding: 1rem; margin: 0;">
                        <span class="empty-state-icon" style="font-size: 2rem;">üìä</span>
                        <div class="empty-state-text">No XP history yet</div>
                        <div class="empty-state-hint">Add or spend XP to track your character's progression</div>
                    </div>

                    <div x-show="xpLog.length > 0" class="xp-log-entries">
                        <template x-for="(entry, idx) in xpLog.slice().reverse()" :key="idx">
                            <div class="xp-log-entry" :class="entry.type">
                                <span class="xp-date" x-text="entry.date"></span>
                                <span class="xp-amount" x-text="(entry.type === 'add' ? '+' : '-') + entry.amount"></span>
                                <span class="xp-reason" x-text="entry.reason"></span>
                            </div>
                        </template>
                    </div>
                </div>
            </section>
            
        </div>
        
    </div>
    
    <div class="back-link">
        <a href="/vtm">‚Üê Back to Character List</a>
    </div>

    </div><!-- End main content wrapper -->

</div>
{% endblock %}

{% block extra_scripts %}
<script src="/static/js/character-sheet.js?v={{ static_version }}"></script>
{% endblock %}
